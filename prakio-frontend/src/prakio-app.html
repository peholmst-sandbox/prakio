<!--
@license
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../bower_components/vaadin-icons/vaadin-icons.html">

<!-- Theme with colors -->
<link rel="import" href="shared-styles.html">

<!-- Lazily import views. They will be explicitly imported on demand using JavaScript. -->
<link rel="lazy-import" href="assignments-view.html">
<link rel="lazy-import" href="error-view.html">

<dom-module id="prakio-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: #fff;
        background-color: var(--default-primary-color);
        @apply --shadow-elevation-3dp;
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }
    </style>

    <!-- 
      I've added longer comments than I usually do to this HTML document. The reason is that this application
      is my first serious attempt at creating a fully functional Polymer application and writing extensive comments
      is a way of learning and figuring out what everything does and how the parts fit together.
    -->   

    <!--
      The 'app-location' element synchronizes the browser location bar and the state of the web app.
        
        'route' is used to pass information to the 'app-route' element below.
        
        'url-space-regex' specifies what kind of URLs should be considered part of this web app.
          Links matching this regex will only cause the URL state to be updated in place, without
          actually navigating to the new page. 'rootPath' is a property that contains the root path
          of the web app, so in this case we match all URLs that begin with the root path of our app.
    -->
    <app-location route="{{route}}" url-space-regex="^[[rootPath]]"></app-location>
    <!--
      The 'app-route' element is used to drive the actualy routing within the web page, even though
      it does not care what happens when a route is changed.
        
        'route' is used to link this element with the 'app-location' element. We don't access this
          information directly anywhere else in the application.

        'pattern' is the pattern that should be matched for the 'data' property to be updated. 'rootPath'
          contains the root path of the web app and ':page' is the placeholder for the page that we
          should navigate to. So for example, if the path is '/about' and the pattern is '/:page', then
          the page we are navigating to will be 'about'.

        'data' is a property that changes when a matching route has been found. This is the property
          the application is using to actually change the DOM.

        'tail' is a property that contains any remaining parts of the route state after the pattern has
          been applied.
    -->
    <app-route
        route="{{route}}"
        pattern="[[rootPath]]:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

    <!-- 
      This is the main layout of the application. 
      
        'fullbleed' causes the layout to fill the entire container (screen).

        'narrow' is a read-only property that is bound so that we can react when it changes. 
    -->
    <app-drawer-layout fullbleed narrow="{{narrow}}">
      <!-- 
        The drawer is the main menu that can slide in from the left. When the layout is 'narrow'.
        the main menu is automatically hidden but can be swiped open. The menu can also be toggled from
        the menu button.
      -->
      <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]">
        <!-- TODO Implement menu -->
        <app-toolbar>Menu</app-toolbar>
        <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
          <a name="view1" href="[[rootPath]]view1">View One</a>
          <a name="view2" href="[[rootPath]]view2">View Two</a>
          <a name="view3" href="[[rootPath]]view3">View Three</a>
        </iron-selector>
      </app-drawer>

      <!-- Main content -->
      <app-header-layout has-scrolling-region>

        <app-header slot="header" reveals effects="waterfall">
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <!-- TODO How to fill in parts here from the iron-pages below? -->
          </app-toolbar>
        </app-header>        

        <!--
          The 'iron-pages' element is used for actually navigating between views, updating the DOM.
          The views are themselves custom elements that are loaded on demand using JavaScript.

          'selected' is the currently selected view/page.

          'attr-for-selected' is an attribute on the child elements of 'iron-pages' that should be used
            to pick the correct view to show.

          'fallback-selection' is the view that should be shown if 'selected' contains a value that can't
            be found within the child elements.

          'role' is used for ARIA and has nothing to do with the 'iron-pages' element itself.
        -->
        <iron-pages
            selected="[[page]]"
            attr-for-selected="name"
            fallback-selection="error"
            role="main">
          <assignments-view name="assignments"></assignments-view>
          <!-- TODO Add additional views here. Files should be named '[name]-view.html'. -->
          <error-view name="error"></error-view>
        </iron-pages>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    class PrakioApp extends Polymer.Element {
      static get is() { return 'prakio-app'; }

      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged',
          },
          routeData: Object,
          subroute: String,
          // This shouldn't be neccessary, but the Analyzer isn't picking up
          // Polymer.Element#rootPath
          rootPath: String,
        };
      }

      static get observers() {
        return [
          // A complex observer that observes a change of a nested property.
          '_routePageChanged(routeData.page)',
        ];
      }

      // This method is invoked whenever the 'routeData.page' property is changed. This means
      // we should navigate to a different view within our application.
      _routePageChanged(page) {
        // If no page was found in the route data, page will be an empty string.
        // Deault to 'assignments' in that case.
        this.page = page || 'assignments';

        // Close a non-persistent drawer when the page & route are changed.
        if (!this.$.drawer.persistent) {
          this.$.drawer.close();
        }
      }

      // This method is invoked whenever the 'page' property is changed. This property can be set as
      // an attribute of the 'prakio-app' element, but is also set by e.g. the '_routePageChanged' method.
      _pageChanged(page) {
        // Load page on demand. Show error view on failures.
        var resolvedPageUrl = this.resolveUrl(page + '-view.html');
        Polymer.importHref(
            resolvedPageUrl,
            null,
            this._showErrorPage.bind(this),
            true);
      }

      // This method shows the error view. The error view is treated as any other view and needs to be
      // declared and imported like the others.
      _showErrorPage() {
        this.page = 'error';
      }
    }

    window.customElements.define(PrakioApp.is, PrakioApp);
  </script>
</dom-module>
